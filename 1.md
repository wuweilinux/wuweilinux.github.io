需求：

每个用户有数台虚拟机，这几台虚拟机内部能互相通行，但不能与其他用户的虚拟机通信

每个用户的虚拟机都能与公共网段的服务器通信，如NTP服务器、DNS服务器、路由器内网口等

 

思路：

在主VLAN 1030 下创建辅助VLAN：

隔离VLAN 31

团体VLAN 32

团体VLAN 33

VLAN 1040 用于放置公共服务器

 

31内的主机互相中间不能通信，只能与1030内的主机通信

32内的主机可以互相通信

33内的主机可以互相通信

32和33的主机不能互相通信

32和33的所有主机可以和1030内的主机通信

 

##你好
分布式虚拟交换机的配置：

 

ESXi只有使用vCenter才能支持分布式虚拟交换机和PVLAN

这里选择服务器的一个物理口作为分布式虚拟机交换机的上行口和物理交换机对接

图片 

如图，这里服务器的vmnic3作为一个上行口连接物理交换机的FastEthernet2/0/46

创建了4个端口组，分别对应1030、31、32、33

创建4台虚拟机，选择合适的端口组

这里没有把ESXi主机的管理端口组迁移到虚拟机交换机上，主要是考虑在分布式虚拟交换机故障的情况下，还能够连接ESXi主机进行管理

 

交换机配置：

vlan 31

  private-vlan isolated

!

vlan 32

  private-vlan community

!

vlan 33

  private-vlan community

!

vlan 1030

  private-vlan primary

  private-vlan association 31-33

 

vlan 1040

 

interface FastEthernet2/0/46

 switchport trunk encapsulation dot1q

 switchport mode trunk

 

 

interface Vlan1030

 ip address 192.168.30.1 255.255.255.0

 private-vlan mapping 31-33

!

interface Vlan1040

 ip address 192.168.40.1 255.255.255.0


 

测试：

所有虚拟机可以ping通网关 192.168.30.1 ，也能ping通另一个VLAN的 192.168.40.1

Node1 由于在隔离VLAN 31 中，无法与两个团体VLAN的虚拟机通信

将Node2和Node3放在VLAN 32中，可以互相通信

将Node2放在VLAN32中，将Node3放在VLAN33中，互相不能通信

将Node3放在VLAN31中，无法与Node1通信

 

后续：

考虑公共服务器是放在另一个VLAN中，还是放到VLAN1030的混杂端口上
多租户环境下B类C类地址如何选，掩码怎么写

如果原来某用户有多个团体VLAN，忽然想要能够某几个团体VLAN间能互相通信，是将要通讯的虚拟机全部放到同一个团体VLAN下，还是物理交换机上有命令，可以批量实现该功能

如果用户需要的不是IP层的互通，而是应用层，如80端口的访问，该如何设置；团体VLA内部如何实现访问控制策略 
